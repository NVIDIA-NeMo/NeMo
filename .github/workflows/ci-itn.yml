name: CI-ITN

on:
  push:
    branches:
      - main
      - '**itn**'
      - 'action_**'

  pull_request:
    branches:
      - main
      - '**itn**'

jobs:
  ci-itn:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: true
      matrix:
        container-ver:
          - 21.06-py3

    container:
      image: nvcr.io/nvidia/pytorch:${{ matrix.container-ver }}
      credentials:
        username: ${{ secrets.nvcr_user }}
        password: ${{ secrets.nvcr_token }}

    steps:
    - uses: actions/checkout@v2

    - name: Install test dependencies
      run:  |
        # install test requirements
        pip install -r requirements/requirements_test.txt

    - name: Install dependencies
      run: |
        # Install nemo requirements
        for f in $(ls requirements/requirements*.txt); do pip install --disable-pip-version-check -r $f; done

        # Install ITN requirements
        /bin/bash nemo_text_processing/setup.sh

        # Install NeMo
        pip install -e "."

    - name: CPU Tests
      run: |
        pytest tests/nemo_text_processing/ -m "not pleasefixme" --cpu
