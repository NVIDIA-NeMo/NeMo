name: NeMo E2E Tests
on:
  workflow_call:
    inputs:
      test_to_run:
        required: true
        type: string

jobs:
  collections-asr-tests:
    strategy:
      matrix:
        include:
          - script: ASR_dev_run_Speech_to_Text
            runner: self-hosted-azure-gpus-1
          - script: ASR_dev_run_Speech_to_Text_WPE_CitriNet
            runner: self-hosted-azure-gpus-1
          - script: ASR_dev_run_Speech_Pre-training_-_CitriNet
            runner: self-hosted-azure-gpus-1
          - script: Optional_ASR_dev_run_Speech_To_Text_Finetuning
            runner: self-hosted-azure-gpus-1
            is_optional: true
          - script: Optional_ASR_dev_run_Speech_To_Text_HF_Finetuning
            runner: self-hosted-azure-gpus-1
            is_optional: true
          - script: ASR_dev_run_Speech_to_Text_WPE_-_Conformer
            runner: self-hosted-azure-gpus-1
          - script: ASR_dev_run-part_two_Speech_to_Text_WPE_-_Squeezeformer
            runner: self-hosted-azure-gpus-1
          - script: L2_Speech_to_Text_EMA
            runner: self-hosted-azure
          - script: L2_Speech_to_Text_AED
            runner: self-hosted-azure-gpus-1
          - script: L2_Speaker_dev_run_Speaker_Recognition
            runner: self-hosted-azure-gpus-1
          - script: L2_Speaker_dev_run_Speaker_Diarization
            runner: self-hosted-azure-gpus-1
          - script: L2_Speaker_dev_run_EndtoEnd_Speaker_Diarization_Sortformer
            runner: self-hosted-azure-gpus-1
          - script: L2_Speaker_dev_run_EndtoEnd_Diarizer_Inference
            runner: self-hosted-azure
          - script: L2_Speaker_dev_run_Speech_to_Label
            runner: self-hosted-azure-gpus-1
          - script: L2_Speaker_dev_run_Speaker_Diarization_with_ASR_Inference
            runner: self-hosted-azure
          - script: L2_Speaker_dev_run_Clustering_Diarizer_Inference
            runner: self-hosted-azure
          - script: L2_Speaker_dev_run_Neural_Diarizer_Inference
            runner: self-hosted-azure
          - script: L2_Speaker_dev_run_Multispeaker_ASR_Data_Simulation
            runner: self-hosted-azure
    uses: ./.github/workflows/_test_template.yml
    with:
      RUNNER: ${{ matrix.runner }}
      SCRIPT: ${{ matrix.script }}
      IS_OPTIONAL: ${{ matrix.is_optional || false }}

  collections-tts-tests:
    strategy:
      matrix:
        include:
          - script: L2_TTS_Fast_dev_runs_1_Tacotron_2
            runner: self-hosted-azure-gpus-1
          - script: L2_TTS_Fast_dev_runs_1_WaveGlow
            runner: self-hosted-azure
          - script: L2_TTS_Fast_dev_runs_1_FastPitch
            runner: self-hosted-azure
          - script: L2_TTS_Fast_dev_runs_1_Hifigan
            runner: self-hosted-azure
    uses: ./.github/workflows/_test_template.yml
    with:
      RUNNER: ${{ matrix.runner }}
      SCRIPT: ${{ matrix.script }}

  collections-llm-tests:
    strategy:
      matrix:
        include:
          - script: L2_NeMo_2_GPT_Pretraining_no_transformer_engine
            runner: self-hosted-azure
          - script: L2_NeMo_2_llama3_pretraining_recipe
            runner: self-hosted-azure
          - script: L2_NeMo_2_llama3_fault_tolerance_plugin
            runner: self-hosted-azure
          - script: L2_NeMo_2_llama3_straggler_detection
            runner: self-hosted-azure
          - script: L2_NeMo_2_GPT_DDP_Param_Parity_check
            runner: self-hosted-azure
          - script: L2_NeMo_2_Hyena_Conversion_from_HF
            runner: self-hosted-azure
          - script: L2_NeMo_2_Hyena_DDP_Pretraining_Test
            runner: self-hosted-azure
          - script: L2_NeMo_2_SSM_Pretraining
            runner: self-hosted-azure-gpus-1
          - script: L2_NeMo_2_SSM_Finetuning
            runner: self-hosted-azure-gpus-1
          - script: L2_NeMo_2_HF_MODEL_IMPORT
            runner: self-hosted-azure
          - script: L2_NeMo_2_jit_callback
            runner: self-hosted-azure
          - script: L2_NeMo_2_T5_Pretraining
            runner: self-hosted-azure
          - script: L2_NeMo_2_T5_Finetuning
            runner: self-hosted-azure
          - script: L2_NeMo_2_T5_LoRA
            runner: self-hosted-azure
          - script: L2_NeMo_2_BERT_Pretraining_Megatron
            runner: self-hosted-azure
          - script: L2_NeMo_2_BERT_Pretraining_HuggingFace
            runner: self-hosted-azure
    uses: ./.github/workflows/_test_template.yml
    with:
      RUNNER: ${{ matrix.runner }}
      SCRIPT: ${{ matrix.script }}

  collections-vlm-tests:
    strategy:
      matrix:
        include:
          - script: L2_VLM_HF_Transformer_PEFT
            runner: self-hosted-azure-gpus-1
          - script: L2_VLM_HF_Transformer_PEFT_FSDP2
            runner: self-hosted-azure
          - script: L2_VLM_HF_Transformer_PEFT_4bit
            runner: self-hosted-azure-gpus-1
          - script: L2_VLM_HF_Transformer_SFT_FSDP2
            runner: self-hosted-azure
          - script: L2_NeMo_2_LLAVA_NEXT_MOCK_TRAINING
            runner: self-hosted-azure
          - script: L2_NeMo_2_LLAVA_NEXT_HF_CONVERSION
            runner: self-hosted-azure
          - script: L2_NeMo_2_LLAVA_NEXT_ENERGON_TRAIN
            runner: self-hosted-azure
          - script: L2_NeMo_2_LLAVA_NEXT_ENERGON_PACKED_TRAIN
            runner: self-hosted-azure
          - script: L2_NeMo_2_CLIP_PRETRAIN
            runner: self-hosted-azure
          - script: L2_NeMo_2_CLIP_INFER
            runner: self-hosted-azure
    uses: ./.github/workflows/_test_template.yml
    with:
      RUNNER: ${{ matrix.runner }}
      SCRIPT: ${{ matrix.script }}

  core-tests:
    strategy:
      matrix:
        include:
          - script: L0_Setup_Test_Data_And_Models
            runner: self-hosted-azure
          - script: L2_NeMo_2_VLLM_EXPORT
            runner: self-hosted-azure
          - script: L2_NeMo_2_EVAL
            runner: self-hosted-azure-gpus-1
          - script: L2_NeMo_2_Auto_Configurator_llama_TP1_PP1_MBS124
            runner: self-hosted-azure-gpus-1
          - script: L2_NeMo_2_Auto_Configurator_bert_TP1_PP1_MBS124
            runner: self-hosted-azure-gpus-1
          - script: L2_NeMo_2_Auto_Configurator_t5_TP1_PP1_MBS124
            runner: self-hosted-azure-gpus-1
          - script: L2_NeMo_2_Conversion_Test_Baichuan2
            runner: self-hosted-azure
          - script: L2_NeMo_2_Conversion_Test_ChatGLM
            runner: self-hosted-azure
          - script: L2_NeMo_2_Conversion_Test_DeepSeek
            runner: self-hosted-azure
          - script: L2_NeMo_2_Conversion_Test_Gemma
            runner: self-hosted-azure
          - script: L2_NeMo_2_Conversion_Test_Gemma2
            runner: self-hosted-azure
          - script: L2_NeMo_2_Conversion_Test_Mistral
            runner: self-hosted-azure
          - script: L2_NeMo_2_Conversion_Test_Llama
            runner: self-hosted-azure
          - script: L2_NeMo_2_Conversion_Test_Llama_Embedding
            runner: self-hosted-azure
          - script: L2_NeMo_2_Conversion_Test_Nemotron
            runner: self-hosted-azure
          - script: L2_NeMo_2_Conversion_Test_Phi3Mini
            runner: self-hosted-azure
          - script: L2_NeMo_2_Conversion_Test_Qwen2
            runner: self-hosted-azure
          - script: L2_NeMo_2_Conversion_Test_Starcoder
            runner: self-hosted-azure
          - script: L2_NeMo_2_Conversion_Test_Starcoder2
            runner: self-hosted-azure
          - script: L2_NeMo_2_Conversion_Test_BERT
            runner: self-hosted-azure
    uses: ./.github/workflows/_test_template.yml
    with:
      RUNNER: ${{ matrix.runner }}
      SCRIPT: ${{ matrix.script }}
